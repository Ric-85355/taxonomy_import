# Инструмент импорта таксономий WooCommerce  
Инструмент на базе WP-CLI для импорта и обновления таксономий продуктов WooCommerce из CSV-файла. Разрабатывался для импорта таксономий, которые создаются и поддерживаются через функцию register_taxonomy (в моем случае как плагин)
Этот инструмент упрощает управление назначением таксономий для продуктов, обеспечивая надежную валидацию, обработку ошибок и подробную отчетность.
Примечание: проект находится в разработке, и его функциональность не полностью протестирована.

### Возможности  
**Основная функциональность**  
- Читает CSV-файл, содержащий SKU и значения таксономий.  
- Получает ID продуктов по SKU.  
- Обновляет или заменяет термины таксономий для продуктов.  
- Обрабатывает случаи, когда продукты или таксономии не найдены.  
- Поддерживает несколько терминов таксономий и обнаруживает дубликаты.  
- Генерирует подробную статистику и записывает результаты в файл с временной меткой.

**Валидация CSV**  
- Проверяет структуру CSV (стабильное количество столбцов, пустые строки/ячейки).  
- Проверяет наличие дублирующихся SKU в файле.  
- Проверяет кодировку UTF-8.  
- Обрабатывает отсутствующие или лишние ячейки в строках.

**Обработка ошибок**  
- Прерывает выполнение при критических ошибках базы данных, сообщая о проблемном продукте.  
- Уведомляет пользователя, если лог-файл не может быть создан.  
- Пропускает несуществующие продукты или таксономии с соответствующими уведомлениями.

**Параметры конфигурации**  
- `--verbose`: включает подробный вывод в терминал.  
- `--delimiter`: поддерживает `,` или `;`.  
- `--skip-rows=`: позволяет пропустить указанное количество строк в начале файла.  
- `--dry-run`: имитирует выполнение без внесения изменений в базу данных
- `--batch-size=`: сколько строк выполнить за заход

**Расширенная статистика**  
- Отслеживает время обработки и среднюю скорость (строк/секунду).  
- Сообщает количество обработанных терминов для каждой таксономии.  
- Отображает индикатор прогресса для больших файлов.

**Функции безопасности**  
- Проверяет размер файла, чтобы избежать обработки слишком больших файлов.  
- Поддерживает пакетную обработку с настраиваемым размером пакета.  
- Ограничивает количество одновременно обрабатываемых строк.

**Постобработка**  
- Очищает кэш WordPress после массовых обновлений.  
- Автоматически обновляет счетчики терминов таксономий.  
- Поддерживает опциональное резервное копирование перед внесением изменений.

### Структура программы  
Инструмент модульный для удобства поддержки и обновлений:  

**Инициализация и проверки**  
- Проверяет входные параметры и флаги.  
- Проверяет возможность записи лог-файла.  
- Подтверждает наличие WordPress и WooCommerce.  
- Инициализирует статистику и отслеживание ошибок.

**Валидация CSV**  
- Проверяет существование, доступность файла и кодировку UTF-8.  
- Проверяет размер файла и структуру CSV.  
- Обнаруживает дублирующиеся SKU и обрабатывает пустые строки/ячейки.

**Подготовка данных**  
- Парсит CSV в структурированный массив.  
- Проверяет таксономии, термины и SKU продуктов.  
- Подготавливает данные для обработки или режима `--dry-run`.

**Обновление базы данных**  
- Получает ID продуктов по SKU.  
- Обновляет или заменяет термины таксономий.  
- Обрабатывает ошибки базы данных и собирает статистику операций.

**Завершение и отчетность**  
- Выводит итоговую статистику в терминал.  
- Генерирует подробный лог-файл с временной меткой.  
- Очищает кэш и обновляет счетчики терминов при необходимости.

### Лог-файл вывода  
Инструмент создает лог-файл с именем `taxonomy_update_results_ГГГГ-ММ-ДД_ЧЧ-ММ-СС.log` следующей структуры:  
```
=== РЕЗУЛЬТАТЫ ОБНОВЛЕНИЯ ТАКСОНОМИЙ ===  
Дата: 2025-06-16 14:30:25  
CSV-файл: export2.v6.csv  
Режим: [ОБНОВЛЕНИЕ/ЗАМЕНА]  

СТАТИСТИКА:  
Всего обработано строк: 4  
Найдено продуктов: 3  
Продуктов не найдено: 1  
Обновлено таксономий: 6  
Пропущено таксономий (уже существуют): 2  

ОШИБКИ:  
Продукты не найдены:  
- S-99999  
Термины не найдены:  
- stone_type: "Unknown Stone"  
Обнаружены дублирующиеся термины:  
- size_mm: "50mm" (ID: 123, 456)  
Пропущены существующие таксономии:  
- S-00816: stone_type "Agate"  
- S-01041: size_mm "50–54 mm (≈1.93–2.13 inch)"  
```

### Установка  taxonomy_import.phpz
1. Убедитесь, что WP-CLI и WooCommerce установлены.  
2. Все файлы (на момент написания этого файла - taxonomy_import.php, PaxonomyTermProcessor.php, taxonomy_import_register.php) поместить в отдельную директорию
   а) taxonomy_import.php - основной скрипт
   b) PaxonomyTermProcessor.php - класс для обработки входного файла и подготовки данных для импорта
   c) taxonomy_import_register.php - функция для регистрации команды WP_CLI taxonomy-import (чтобы можно было использовать wp taxonomy-import)

### Подготовка файла с терминами для импорта
В первой строке указываются заголовки столбцов
- первый столбец должен иметь название SKU - по нему будут инициализироваться товары (артикул)
- второй и последующий столбы - названия таксономий, как они указаны в функции register_taxonomy
Во второй и последующих строках:
- первая колонка - артикулы (SKU)
- вторая и последующая - термины таксономии, обрабатываются по следующим правилам
  - если указан просто термин
    - если термин уникальный - он будет закреплен за товаром
    - если термин неуникальный - будет выведена ошибка
  - если указан полный путь с родителем (с разделителем ">")
    - если термин найдет - он будет закреплен за товаром
    - если термин или родитель не найдет - будет выведена ошибка

### Использование  
Перед импортом рекомендуется сделать полную копию базы данных:
```bash
wp db export /путь/к/папке/backup.sql
```
Если неудачно, то восстанавливаем базу:
```bash
wp db import имя_файла.sql
```
Перед импортом регистрируем команду taxonomy-import (нужно регистрировать в каждой ssh-сессии)
```bash
wp eval-file path/to/register-command.php
```
После регистрации импорт выполняется с помощью WP-CLI:  
```bash
wp taxonomy-import path/to/file.csv --mode=update|replace [--dry-run] [--verbose] [--delimiter=,] [--skip-lines=0] [--batch-size=100]
```
Рекомендуется сначала запустить с флагом --dry-run, затем исправить ошибки, и потом запустить на внесение изменений

### Параметры  
- `--file`: Путь к CSV-файлу.  
- `--delimiter`: Разделитель CSV (`,` или `;`).  
- `--verbose`: Включить подробный вывод.  
- `--dry-run`: Имитировать выполнение без изменений в базе данных.  
- `--skip-rows=<число>`: Пропустить указанное количество строк в начале файла.  
- `--batch-size=<число>`: Количество строк для обработки в одном пакете.

### Требования  
- WordPress с установленным WooCommerce.  
- WP-CLI.  
- PHP 7.4 или выше.

### Лицензия  
GNU General Public License v3.0  

### Вклад  
Приветствуются любые вклады! Пожалуйста, отправляйте запросы на улучшение или исправление ошибок. Все вклады должны быть лицензированы под GNU GPL v3.0, чтобы проект оставался полностью открытым.
